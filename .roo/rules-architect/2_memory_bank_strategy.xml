<memory_bank_strategy>
  <overview>
    <description>
      Strategy for initializing, querying, and maintaining the Memory Bank system 
      in Architect mode. Memory Bank provides persistent context across sessions.
    </description>
  </overview>

  <initialization>
    <workflow>
      <step number="1">
        <action>Check for Memory Bank existence</action>
        <thinking_process><![CDATA[
<thinking>
- CHECK FOR MEMORY BANK:
  * First, check if the memory-bank/ directory exists.
</thinking>
        ]]></thinking_process>
        <tool_usage>
          <tool>list_files</tool>
          <path>.</path>
          <recursive>false</recursive>
        </tool_usage>
      </step>

      <step number="2">
        <action>Determine next action based on existence</action>
        <thinking_process><![CDATA[
<thinking>
  * If memory-bank DOES exist, skip immediately to if_memory_bank_exists section.
  * If memory-bank does NOT exist, proceed to no_memory_bank_workflow.
</thinking>
        ]]></thinking_process>
      </step>
    </workflow>
  </initialization>

  <no_memory_bank_workflow>
    <step number="1">
      <action>Inform the user</action>
      <message>
        No Memory Bank was found. I recommend creating one to maintain project context.
      </message>
    </step>

    <step number="2">
      <action>Offer initialization</action>
      <description>Ask the user if they would like to initialize the Memory Bank</description>
    </step>

    <step number="3">
      <action>Handle user response</action>
      <conditional_actions>
        <if_user_declines>
          <thinking><![CDATA[
<thinking>
I need to proceed with the task without Memory Bank functionality.
</thinking>
          ]]></thinking>
          <actions>
            <action>Inform the user that the Memory Bank will not be created</action>
            <action>Set the status to '[MEMORY BANK: INACTIVE]'</action>
            <action>Proceed with the task using the current context if needed</action>
            <action>If no task is provided, use the ask_followup_question tool</action>
          </actions>
        </if_user_declines>

        <if_user_agrees>
          <thinking><![CDATA[
<thinking>
I need to create the memory-bank/ directory and core files. I should use write_to_file 
for this, and I should do it one file at a time, waiting for confirmation after each. 
The initial content for each file is defined in initial_content_templates section. 
I need to make sure any initial entries include a timestamp in the format YYYY-MM-DD HH:MM:SS.
</thinking>
          ]]></thinking>
          <prerequisite_check>
            <check>Use list_files to check for projectBrief.md before offering to create the memory bank</check>
            <if_exists>Read its contents before offering to create the memory bank</if_exists>
            <if_not_exists>Skip this step (we'll handle prompting for project info after the user agrees to initialize, if they do)</if_not_exists>
          </prerequisite_check>
          <creation_sequence>
            <step>Create the memory-bank/ directory</step>
            <step>Create memory-bank/productContext.md with initial_content</step>
            <step>Create memory-bank/activeContext.md with initial_content</step>
            <step>Create memory-bank/progress.md with initial_content</step>
            <step>Create memory-bank/decisionLog.md with initial_content</step>
            <step>Create memory-bank/systemPatterns.md with initial_content</step>
            <step>Set status to '[MEMORY BANK: ACTIVE]'</step>
            <step>Inform the user that the Memory Bank has been initialized and is now active</step>
            <step>Proceed with the task using the context from the Memory Bank or if no task is provided, use ask_followup_question tool</step>
          </creation_sequence>
        </if_user_agrees>
      </conditional_actions>
    </step>
  </no_memory_bank_workflow>

  <initial_content_templates>
    <file name="productContext.md">
      <template><![CDATA[
# Product Context

This file provides a high-level overview of the project and the expected product that will be created. Initially it is based upon projectBrief.md (if provided) and all other available project-related information in the working directory. This file is intended to be updated as the project evolves, and should be used to inform all other modes of the project's goals and context.
YYYY-MM-DD HH:MM:SS - Log of updates made will be appended as footnotes to the end of this file.

*

## Project Goal

*   

## Key Features

*   

## Overall Architecture

*   
      ]]></template>
    </file>

    <file name="activeContext.md">
      <template><![CDATA[
# Active Context

  This file tracks the project's current status, including recent changes, current goals, and open questions.
  YYYY-MM-DD HH:MM:SS - Log of updates made.

*

## Current Focus

*   

## Recent Changes

*   

## Open Questions/Issues

*   
      ]]></template>
    </file>

    <file name="progress.md">
      <template><![CDATA[
# Progress

This file tracks the project's progress using a task list format.
YYYY-MM-DD HH:MM:SS - Log of updates made.

*

## Completed Tasks

*   

## Current Tasks

*   

## Next Steps

*
      ]]></template>
    </file>

    <file name="decisionLog.md">
      <template><![CDATA[
# Decision Log

This file records architectural and implementation decisions using a list format.
YYYY-MM-DD HH:MM:SS - Log of updates made.

*

## Decision

*

## Rationale 

*

## Implementation Details

*
      ]]></template>
    </file>

    <file name="systemPatterns.md">
      <template><![CDATA[
# System Patterns *Optional*

This file documents recurring patterns and standards used in the project.
It is optional, but recommended to be updated as the project evolves.
YYYY-MM-DD HH:MM:SS - Log of updates made.

*

## Coding Patterns

*   

## Architectural Patterns

*   

## Testing Patterns

*
      ]]></template>
    </file>
  </initial_content_templates>

  <memory_bank_exists_workflow>
    <overview>
      USE MEMORY QUERY MODE FOR CONTEXT RETRIEVAL instead of reading all files 
      to avoid context overflow risk.
    </overview>

    <session_state_tracking>
      <critical_rule>
        PREVENT REDUNDANT MEMORY QUERIES:
        - Check if memory has been consulted in current session
        - If status is [MEMORY BANK: CONSULTED], skip query and use existing context
        - Only query if status is [MEMORY BANK: ACTIVE]
        - After querying, update status to [MEMORY BANK: CONSULTED]
      </critical_rule>

      <status_states>
        <state name="INACTIVE">Memory Bank does not exist in workspace</state>
        <state name="ACTIVE">Memory Bank exists but not yet consulted this session</state>
        <state name="CONSULTED">Memory Bank has been queried in this session</state>
      </status_states>
    </session_state_tracking>

    <check_consulted_status>
      <rule>Before querying Memory Bank, check current session state</rule>
      <if_status_is_consulted>
        <action>Skip memory query - context already loaded in session</action>
        <action>Use existing knowledge from previous consultation</action>
        <action>Maintain [MEMORY BANK: CONSULTED] status</action>
        <note>This prevents redundant queries and saves time/tokens</note>
      </if_status_is_consulted>
      <if_status_is_active>
        <action>Proceed with memory query decision logic below</action>
      </if_status_is_active>
    </check_consulted_status>

    <decision_point>
      <description>Determine if task requires memory bank knowledge</description>
      
      <requires_knowledge>
        <examples>
          <example>Designing system architecture (check existing patterns)</example>
          <example>Planning features (verify project goals)</example>
          <example>Making technical decisions (review past decisions)</example>
          <example>Creating documentation (understand current state)</example>
          <example>Strategizing implementation (lookup constraints)</example>
        </examples>

        <workflow>
          <step number="1">
            <action>Use new_task tool to start Memory Query Mode</action>
            <tool_usage><![CDATA[
<new_task>
<mode>memory-query</mode>
<message>Need to extract relevant context for: {brief architectural task description}</message>
</new_task>
            ]]></tool_usage>
          </step>

          <step number="2">
            <action>Provide Structured Query (once in Memory Query mode)</action>
            <query_format><![CDATA[
Query: {specific question about what you need to know}
Context: {what you're trying to design or plan}
ParentMode: architect
            ]]></query_format>
          </step>

          <step number="3">
            <action>Receive Condensed Response</action>
            <description>
              Maximum 500 lines vs 2000+ from full read, containing:
              - Key Facts
              - Detailed Context
              - Constraints and Warnings
              - Recommendations
              - Citations
            </description>
          </step>

          <step number="4">
            <action>Return to Architect Mode</action>
            <description>Memory Query mode will switch you back automatically</description>
          </step>

          <step number="5">
            <action>Apply Retrieved Knowledge</action>
            <description>Use the condensed information for architectural planning</description>
          </step>

          <step number="6">
            <action>Set Status to CONSULTED and Proceed</action>
            <status>[MEMORY BANK: CONSULTED]</status>
            <next_action>Proceed with design. Memory has been queried in this session.</next_action>
          </step>
        </workflow>
      </requires_knowledge>

      <does_not_require_knowledge>
        <examples>
          <example>General architecture discussions</example>
          <example>Theoretical design patterns</example>
          <example>Generic best practices</example>
        </examples>

        <workflow>
          <step number="1">
            <action>Maintain current status (ACTIVE or CONSULTED as appropriate)</action>
            <note>Do not change CONSULTED back to ACTIVE if memory was already queried</note>
          </step>
          <step number="2">
            <action>Proceed with architectural planning directly</action>
          </step>
          <step number="3">
            <action>If no task provided, use ask_followup_question tool</action>
          </step>
        </workflow>
      </does_not_require_knowledge>
    </decision_point>

    <fallback_strategy>
      <description>If Memory Query mode is unavailable</description>
      <actions>
        <action>Read memory bank files directly (legacy behavior)</action>
        <action>Focus on most relevant files first</action>
        <action>Note: Higher risk of context overflow</action>
      </actions>
    </fallback_strategy>
  </memory_bank_exists_workflow>

  <general_rules>
    <status_prefix>
      Begin EVERY response with either '[MEMORY BANK: ACTIVE]', '[MEMORY BANK: CONSULTED]', or '[MEMORY BANK: INACTIVE]', 
      according to the current state of the Memory Bank.
    </status_prefix>
  </general_rules>

  <memory_bank_updates>
    <frequency>
      MAKE SURE TO UPDATE MEMORY BANK THROUGHOUT THE CHAT SESSION, 
      WHEN SIGNIFICANT CHANGES OCCUR IN THE PROJECT.
    </frequency>

    <file_update_rules>
      <file name="decisionLog.md">
        <trigger>
          When a significant architectural decision is made (new component, data flow change, 
          technology choice, etc.). Use your judgment to determine significance.
        </trigger>
        <thinking><![CDATA[
<thinking>
I need to update decisionLog.md with a decision, the rationale, and any implications.
Use insert_content to *append* new information. Never overwrite existing entries. 
Always include a timestamp.
</thinking>
        ]]></thinking>
        <format>[YYYY-MM-DD HH:MM:SS] - [Summary of Change/Focus/Issue]</format>
      </file>

      <file name="productContext.md">
        <trigger>
          When the high-level project description, goals, features, or overall architecture 
          changes significantly. Use your judgment to determine significance.
        </trigger>
        <thinking><![CDATA[
<thinking>
A fundamental change has occurred which warrants an update to productContext.md.
Use insert_content to *append* new information or use apply_diff to modify existing entries 
if necessary. Timestamp and summary of change will be appended as footnotes to the end of the file.
</thinking>
        ]]></thinking>
        <format>(Optional)[YYYY-MM-DD HH:MM:SS] - [Summary of Change]</format>
      </file>

      <file name="systemPatterns.md">
        <trigger>
          When new architectural patterns are introduced or existing ones are modified. 
          Use your judgement.
        </trigger>
        <thinking><![CDATA[
<thinking>
I need to update systemPatterns.md with a brief summary and time stamp.
Use insert_content to *append* new patterns or use apply_diff to modify existing entries 
if warranted. Always include a timestamp.
</thinking>
        ]]></thinking>
        <format>[YYYY-MM-DD HH:MM:SS] - [Description of Pattern/Change]</format>
      </file>

      <file name="activeContext.md">
        <trigger>
          When the current focus of work changes, or when significant progress is made. 
          Use your judgement.
        </trigger>
        <thinking><![CDATA[
<thinking>
I need to update activeContext.md with a brief summary and time stamp.
Use insert_content to *append* to the relevant section (Current Focus, Recent Changes, 
Open Questions/Issues) or use apply_diff to modify existing entries if warranted. 
Always include a timestamp.
</thinking>
        ]]></thinking>
        <format>[YYYY-MM-DD HH:MM:SS] - [Summary of Change/Focus/Issue]</format>
      </file>

      <file name="progress.md">
        <trigger>
          When a task begins, is completed, or if there are any changes. Use your judgement.
        </trigger>
        <thinking><![CDATA[
<thinking>
I need to update progress.md with a brief summary and time stamp.
Use insert_content to *append* the new entry, never overwrite existing entries. 
Always include a timestamp.
</thinking>
        ]]></thinking>
        <format>[YYYY-MM-DD HH:MM:SS] - [Summary of Change/Focus/Issue]</format>
      </file>
    </file_update_rules>
  </memory_bank_updates>
</memory_bank_strategy>